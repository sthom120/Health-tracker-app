<!DOCTYPE html>
<html lang="en">
<head>
  <!--
    NOTE TO SELF:
    Gatekeeping / lock check:
    - Only redirect if a PIN exists.
    - Run before render to avoid “flash” of protected content.
    - replace() avoids adding this page to history.
  -->
  <script>
    if (localStorage.getItem("pinHash") && !sessionStorage.getItem("unlocked")) {
      window.location.replace("pin-lock.html");
    }
  </script>

  <!-- Standard meta order -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>Daily Tracker</title>

  <!-- iOS “Add to Home Screen” support -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />

  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <!--
    NOTE TO SELF:
    Shared header across pages.
    Logo links back to setup (home/config).
  -->
  <header id="appHeader">
    <div class="logo-row">
      <a href="index.html" aria-label="Go to setup">
        <img src="icons/icon-192.png" alt="Health Tracker Logo" class="app-logo" />
      </a>

      <div class="header-text">
        <h1 id="appTitle">Personal Health Tracker</h1>
        <p class="tagline">Small daily reflections, big long-term insights.</p>
      </div>
    </div>
  </header>

  <main>
    <!-- Quick instruction -->
    <section class="intro-section" aria-label="Page intro">
      <p class="intro-text">Record today’s data (or choose another date). Fill in what applies.</p>
    </section>

    <!--
      NOTE TO SELF:
      Date is the main key for entries (“one per day” unless overwriting).
      track.js:
      - defaults to today
      - sets the entry date when editing an existing entry
    -->
    <section class="date-card" aria-label="Entry date">
      <label for="entryDate">Date (required):</label>
      <input type="date" id="entryDate" required />
    </section>

    <!--
      NOTE TO SELF:
      Open the question modal to add/edit/archive questions mid-log.
      Modal logic lives in js/track.js.
    -->
    <section class="track-actions" aria-label="Question tools">
      <button id="addQuestionBtn" type="button" class="secondary">➕ Add question</button>
      <button id="manageQuestionsBtn" type="button" class="secondary">✏️ Edit / archive questions</button>
    </section>

    <!--
      NOTE TO SELF:
      dailyForm is generated dynamically from active (non-archived) questions.
      Keep it empty in HTML — track.js populates it.
      (CSS note: you currently style all <form> elements; that will also style this.)
    -->
    <form id="dailyForm" aria-label="Daily entry form"></form>

    <!--
      NOTE TO SELF:
      Free-text context for the day (flare, meds change, unusual stress, etc.)
      This should be stored as entry.comment (NOT inside responses) so it exports cleanly.
    -->
    <section class="entry-card" aria-label="Optional comment">
      <label for="entryComment">
        Comment (optional)
        <textarea
          id="entryComment"
          rows="3"
          placeholder="Anything notable today? (flare, meds change, sleep issue, unusual stress, etc.)"
        ></textarea>
      </label>
    </section>

    <!-- Main actions -->
    <section class="row-actions" aria-label="Entry actions">
      <button id="saveEntry" type="button" class="primary">Save Entry</button>
      <button id="goView" type="button" class="secondary">View Data</button>
      <button id="backToSetupBtn" type="button" class="secondary">Back to Setup</button>
    </section>

    <!-- Non-blocking success message -->
    <div id="saveMessage" class="hidden" role="status" aria-live="polite">✅ Entry saved!</div>

    <!--
      NOTE TO SELF:
      Question modal:
      - Used for question management without leaving the page
      - track.js expects these exact IDs
      - Keep entry comment OUTSIDE this modal (it belongs to the daily entry)
    -->
    <div
      id="questionModal"
      class="modal-overlay hidden"
      role="dialog"
      aria-modal="true"
      aria-labelledby="modalTitle"
    >
      <div class="modal-card">
        <div class="modal-header">
          <h2 id="modalTitle">Manage Questions</h2>
          <button id="closeQuestionModal" type="button" class="modal-close" aria-label="Close">✕</button>
        </div>

        <form id="modalQuestionForm" class="modal-form">
          <label>
            Question text
            <input type="text" id="modalQuestionText" required />
          </label>

          <label>
            Answer type
            <select id="modalQuestionType" required>
              <option value="boolean">Yes / No</option>
              <option value="number">Number</option>
              <option value="text">Short text</option>
              <option value="date">Date</option>
              <option value="select">Select (choose from options)</option>
            </select>
          </label>

          <label>
            Tags (optional, comma-separated)
            <input type="text" id="modalQuestionTags" placeholder="e.g. Morning, Diet" />
          </label>

          <!-- Shown only for "select" type -->
          <div id="modalOptionsContainer" style="display:none;">
            <label>
              Options (comma-separated)
              <input type="text" id="modalQuestionOptions" placeholder="e.g. Gluten, Dairy, Sugar" />
            </label>
          </div>

          <!-- Shown only for "number" type -->
          <div id="modalScaleContainer" style="display:none;">
            <label>
              Number scale (optional)
              <div class="scale-grid">
                <input type="number" id="modalQuestionMin" placeholder="min" />
                <input type="number" id="modalQuestionMax" placeholder="max" />
                <input type="number" id="modalQuestionStep" placeholder="step" step="0.1" />
              </div>
            </label>
          </div>

          <div class="row-actions">
            <button type="submit" class="primary">Save</button>
            <button type="button" id="modalCancelEdit" class="secondary hidden">Cancel edit</button>
          </div>
        </form>

        <h3 class="modal-subtitle">Active questions</h3>
        <ul id="modalQuestionList" class="modal-list"></ul>

        <p class="help-text">
          Tip: If you change a question’s meaning (like the pain scale range), bump version so history stays interpretable.
        </p>
      </div>
    </div>
  </main>

  <!-- Bottom navigation -->
  <nav class="bottom-nav" aria-label="Primary navigation">
    <button type="button" data-href="index.html" data-page="index">Setup</button>
    <button type="button" data-href="track.html" data-page="track">Track</button>
    <button type="button" data-href="view.html" data-page="view">View</button>
  </nav>

  <footer style="text-align:center; margin-top:3rem; font-size:0.85rem; color:#888;">
    © <span id="year"></span> The Idiom Lab
  </footer>

  <!--
    NOTE TO SELF:
    Tiny shared page glue:
    - Footer year
    - Bottom-nav routing + active highlight
    - Back to setup button
  -->
  <script>
    document.getElementById("year").textContent = new Date().getFullYear();

    const currentPage = window.location.pathname.split("/").pop().split(".")[0];
    document.querySelectorAll(".bottom-nav button").forEach(btn => {
      btn.addEventListener("click", () => {
        const href = btn.dataset.href;
        if (href) window.location.href = href;
      });
      if (btn.dataset.page === currentPage) btn.classList.add("active");
    });

    document.getElementById("backToSetupBtn")?.addEventListener("click", () => {
      window.location.href = "index.html";
    });
  </script>

  <!-- Page logic -->
  <script type="module" src="js/track.js"></script>
</body>
</html>
